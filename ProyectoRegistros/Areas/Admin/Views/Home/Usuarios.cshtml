@model IEnumerable<ProyectoRegistros.Areas.Admin.Models.ViewModels.UsuariosViewModel>
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    Layout = "LayoutAdmin";
}
@if (TempData["ExitoUsuario"] != null)
{
    <script>alert('@TempData["ExitoUsuario"]');</script>
}
@if (TempData["ErrorUsuario"] != null)
{
    <script>alert('@TempData["ErrorUsuario"]');</script>
}


<!--MODAL PARA AGREGAR-->
<div class="modal" id="modal-AddUsuario">
    <form id="formAddUsuario" asp-area="Admin" asp-controller="Usuarios" asp-action="AgregarUsuario" method="post" style="margin: 18vh auto;">
        <button class="cerrar" type="button">X</button><br>
        <div id="acomodar">
            <i class="material-symbols-outlined">person</i>
            <h2>Agregar Usuario</h2>
        </div><br>

        <label>Nombre:</label><br>
        <input class="inputForms" type="text" name="Nombre" placeholder="Escribir..." required><br>

        <label>Correo Electrónico:</label><br>
        <input class="inputForms" type="email" name="Correo" placeholder="Escribir..." required><br>

        <label>Número Telefónico:</label><br>
        <input class="inputForms" type="text" name="NumTel" placeholder="Escribir..." required><br>

        <label>Rol:</label><br>
        <select class="inputForms" name="IdRol" style="height: 3.5vh;" required>
            <option value="1">Administrador</option>
            <option value="2">Profesor</option>
            <option value="3">Visitante</option>
        </select>

        <div style="display: flex; justify-content: center;">
            <button id="btnGuardarUsuario" style="margin: -0vh 0; position:static;" type="submit" class="buttons">Guardar</button>
        </div>
    </form>
</div>

<!--MODAL PARA EDITAR-->
<div class="modal" id="modal-EditUsuario">
    <form asp-area="Admin" asp-controller="Usuarios" asp-action="EditarUsuario" method="post" style="margin: 18vh auto; text-align: left;">
        <input type="hidden" name="Id" id="EditUsuarioId" />
        <button class="cerrar" type="button">X</button><br>
        <div id="acomodar">
            <i class="material-symbols-outlined">person</i>
            <h2>Editar Usuario</h2>
        </div><br>

        <label>Nombre:</label><br>
        <input class="inputForms" id="editNombreUsu" type="text" name="Nombre" required><br>

        <label>Correo Electrónico:</label><br>
        <input class="inputForms" id="editCorreo" type="email" name="Correo"required><br>

        <label>Número Telefónico:</label><br>
        <input class="inputForms" id="editTel" type="text" name="NumTel" required><br>

        <label>Contraseña:</label><br>
        <input class="inputForms" id="editContraseña" type="text" name="Contraseña"
               placeholder="Dejar en blanco para no cambiar la contraseña" /><br />

        <label>Rol:</label><br>
        <select class="inputForms" name="IdRol" id="editRol" style="height: 3.5vh;">
            <option value="1">Administrador</option>
            <option value="2">Profesor</option>
            <option value="3">Visitante</option>
        </select>



        <div style="display:flex; justify-content:center;">
            <button style="margin: -0vh 0; position:static;" type="submit" class="buttons">Guardar</button>
        </div>
    </form>
</div>

<!--MODAL PARA ELIMINAR-->
<div class="modal" id="modal-DeleteUsuario">
    <form asp-area="Admin" asp-action="EliminarUsuario" asp-controller="Usuarios" id="formDeleteUsuario" method="post" style="margin: 33vh auto;">
        <input type="hidden" id="DeleteUsuarioId" name="id" />
        <button class="cerrar" type="button">X</button><br>
        <fieldset>
            <legend>
                <h2>¿Desea eliminar este usuario?</h2>
                <label style="color: red; font-size: 3vh;"></label>
            </legend>
        </fieldset>
        <div style="margin: 0vh 0 0 1vw; justify-content: flex-end; display: flex;">
            <button type="submit" class="buttons">Confirmar</button>
        </div>
    </form>
</div>





<header class="principal">
    <div class="izq">
        <i class="menu material-symbols-outlined">menu</i>
        <h2>Usuarios</h2>
    </div>
    <img id="ig2" src="~/img/Historial.png" />
</header>


<form asp-area="Admin" asp-controller="Home" asp-action="Usuarios" method="get" id="filtro-form-usuarios">
    <div class="filtros2">
        <div class="buscador2">
            <input id="search-usuarios" name="searchTerm" type="search"
                   placeholder="Buscar" value="@ViewData["CurrentFilter"]" />
        </div>
        <input id="aggUsuario" type="button" value="Crear usuario" />
    </div>
</form>

<div id="tabla-container">
    @await Html.PartialAsync("~/Areas/Admin/Views/Home/_UsuariosTabla.cshtml", Model)
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        const searchInput = document.getElementById('search-usuarios');
        const tablaContainer = document.getElementById('tabla-container');
        let debounceTimer;

        function actualizarTabla() {
            const searchTerm = searchInput.value;
            const url = `@Url.Action("Usuarios", "Home")?searchTerm=${encodeURIComponent(searchTerm)}`;

            fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.text())
            .then(html => tablaContainer.innerHTML = html)
            .catch(error => console.error('Error al actualizar la tabla:', error));
        }

        searchInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(actualizarTabla, 300);
        });

        searchInput.addEventListener('input', function() {
            const regex = /[^a-zA-Z\s\u00C0-\u017F]/g;
            this.value = this.value.replace(regex, '');
        });

        tablaContainer.addEventListener('click', async function(event) {

            const editButton = event.target.closest('.btneditar.usuario');
            if (editButton) {
                event.preventDefault();
                const id = editButton.dataset.id;

                try {
                    const response = await fetch(`/Admin/Usuarios/GetUsuario?id=${id}`);
                    if (!response.ok) throw new Error("Error al obtener usuario");

                    const data = await response.json();

                    document.getElementById("EditUsuarioId").value = data.id;
                    document.getElementById("editNombreUsu").value = data.nombre;
                    document.getElementById("editCorreo").value = data.correo;
                    document.getElementById("editTel").value = data.numTel;
                    document.getElementById("editContraseña").value = "";
                    document.getElementById("editRol").value = data.idRol;

                    document.getElementById("modal-EditUsuario").style.display = "block";

                } catch (err) {
                    console.error(err);
                    alert("Error al cargar datos del usuario");
                }
            }

            const deleteButton = event.target.closest('.btneliminar.usuario');
            if (deleteButton) {
                event.preventDefault();
                const id = deleteButton.dataset.id;
                const nombre = deleteButton.dataset.nombre;

                document.getElementById("DeleteUsuarioId").value = id;
                document.querySelector("#modal-DeleteUsuario label").textContent = nombre;
                document.getElementById("modal-DeleteUsuario").style.display = "block";
            }
        });

        document.getElementById("aggUsuario")?.addEventListener("click", function () {
            document.getElementById("modal-AddUsuario").style.display = "block";
        });

        document.body.addEventListener('click', function(event) {
            if (event.target.classList.contains('cerrar')) {
                const modal = event.target.closest('.modal');
                if (modal) modal.style.display = 'none';
            }
        });

        const formAddUsuario = document.getElementById("formAddUsuario");
        const btnGuardarUsuario = document.getElementById("btnGuardarUsuario");


        if (formAddUsuario) {
    formAddUsuario.addEventListener("submit", async function (e) {
        e.preventDefault();

            btnGuardarUsuario.disabled = true;
            btnGuardarUsuario.textContent = "Guardando...";

        const formData = new FormData(formAddUsuario);

        try {
            const response = await fetch("/Admin/Usuarios/AgregarUsuario", {
                method: "POST",
                body: formData
            });

            const data = await response.json();

            if (data.success === "reactivar") {

                btnGuardarUsuario.disabled = false;
                btnGuardarUsuario.textContent = "Guardar";

                const confirmar = confirm(data.message);

                if (confirmar) {
                    const formReactivar = new FormData();
                    formReactivar.append("id", data.id);

                    const respReactivar = await fetch("/Admin/Usuarios/ReactivarUsuario", {
                        method: "POST",
                        body: formReactivar
                    });

                    const dataReactivar = await respReactivar.json();
                    alert(dataReactivar.message);

                    if (dataReactivar.success) {
                        window.location.reload();
                    }

                    return;
                } else {
                    return;
                }
            }

            alert(data.message);

            if (data.success) {
                document.getElementById("modal-AddUsuario").style.display = "none";
                formAddUsuario.reset();
                window.location.reload();
            }

        } catch (error) {
            console.error("Error al agregar usuario:", error);
            alert("Ocurrió un error al intentar agregar el usuario.");
        }
            btnGuardarUsuario.disabled = false;
            btnGuardarUsuario.textContent = "Guardar";
    });
            }

        const formEditUsuario = document.querySelector("#modal-EditUsuario form");

        if (formEditUsuario) {
            formEditUsuario.addEventListener("submit", async function (e) {
                e.preventDefault();

                const formData = new FormData(formEditUsuario);

                try {
                    const response = await fetch("/Admin/Usuarios/EditarUsuario", {
                        method: "POST",
                        body: formData
                    });

                    const data = await response.json();
                    alert(data.message);

           if (data.success) {

              alert(data.message);

                 if (data.logout) {
                    window.location.href = "/Login/Index";
                    return;
            }

        document.getElementById("modal-EditUsuario").style.display = "none";
        formEditUsuario.reset();
        window.location.reload();
    }


                } catch (error) {
                    console.error("Error editando usuario:", error);
                    alert("Ocurrió un error al intentar editar el usuario.");
                }
            });
        }

    });
</script>
