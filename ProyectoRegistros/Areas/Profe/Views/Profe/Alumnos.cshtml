@using ProyectoRegistros.Models

@model IEnumerable<dynamic>
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    Layout = "LayoutProfe";
}

<header class="principal">
    <div class="izq">
        <img id="ig1" class="reg" src="~/img/arrow_back.png" />
        <h2>Alumnos</h2>
    </div>
    <img id="ig2" src="~/img/Historial.png" />
</header>


<!--MODAL PARA EDITAR-->

<div class="modal" id="modal-EditAlumno">
    <form asp-action="EditarAlumno" asp-controller="Profe" method="post">
        <button class="cerrar" type="button">X</button><br>
        <div id="acomodar">
            <i class="material-symbols-outlined">person</i>
            <h2>Editar alumno</h2>
        </div><br>
        <!--tomar id-->
        <input type="hidden" name="Id" id="editID" />

        <label>Nombre:</label><br>
        <input name="Nombre" id="editNombre" class="inputForms" type="text" placeholder="Mariana...."><br>
        <label>Tutor:</label><br>
        <input name="Tutor" id="editTutor" class="inputForms" type="text" placeholder="Escribir..."><br>
        <label>Teléfono:</label><br>
        <input name="NumContacto" id="editTel" class="inputForms" type="text" placeholder="Escribir..."><br>
        <label>Teléfono 2:</label><br>
        <input name="NumSecundario" id="editTel2" class="inputForms" type="text" placeholder="Escribir..."><br>

        <label>Padecimientos:</label><br>
        <input name="Padecimientos" id="editPadecim" class="inputForms" type="text" placeholder="Escribir..."><br>


        @*  <div class="error" style=" margin-top: 5px; margin-bottom:5px; ">
            <p>El nombre ya existe!</p>
            <p>El nombre del taller ya existe!</p>
        </div> 
         *@

        <div style="display: flex; justify-content: center;">
            <button style="margin: -0vh 0; position:static;" type="submit" class="buttons">Guardar</button>
        </div>
    </form>
</div>

<!--MODAL PARA ELIMINAR-->
<div class="modal" id="modal-DeleteAlumno">
    <form method="post" asp-action="eliminarTallerDelAlumno" asp-controller="Profe" style="margin-top:140px;">
        <button class="cerrar" type="button">X</button><br>

        <input type="hidden" name="Id" id="deleteID" />
        <fieldset style="border:none;">
            <legend>
                <h2>¿Desea eliminar al alumno en alguno de estos talleres?</h2>
                <div class="scroll-eliminar">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 5% !important;">Taller</th>
                                <th>Eliminar</th>
                            </tr>
                        </thead>
                        <tbody id="talleresAlumno">
                            <!--No se pueden cargar los talleres desde aca, pq se cargan los de tooooodos, no los de 1-->
                            <!--se cargan con un json-->
                        </tbody>
                    </table>
                </div>
            </legend>
        </fieldset>
        <div style="margin: 0vh 0 0 1vw; justify-content: flex-end; display: flex;">
            <button id="eliminarAlumno" type="submit" class="buttons">Confirmar</button>
        </div>
    </form>
</div>


<div class="filtros">
    <div class="buscador">
        <input type="search" id="fil" placeholder="Nombre..." />

    </div>


</div>


<div id="tabla-container">
    @await Html.PartialAsync("_ProfeAlumnosTabla", Model)
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        const searchInput = document.getElementById('fil');
        const tablaContainer = document.getElementById('tabla-container');
        let debounceTimer;

        function actualizarTabla() {
            const searchTerm = searchInput.value;
            const url = `@Url.Action("Alumnos", "Profe")?searchTerm=${encodeURIComponent(searchTerm)}`;

            fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.text())
            .then(html => { tablaContainer.innerHTML = html; })
            .catch(error => console.error('Error al actualizar la tabla:', error));
        }

        searchInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(actualizarTabla, 300);
        });

        searchInput.addEventListener('input', function(e) {
            const regex = /[^a-zA-Z\s\u00C0-\u017F]/g;
            this.value = this.value.replace(regex, '');
        });

        tablaContainer.addEventListener('click', async function(event) {

            const editButton = event.target.closest('.btneditar');
            if (editButton) {
                event.preventDefault();
                const dataset = editButton.dataset;

                document.getElementById("editID").value = dataset.id;
                document.getElementById("editNombre").value = dataset.nombre;
                document.getElementById("editTutor").value = dataset.tutor;
                document.getElementById("editTel").value = dataset.numcontacto;
                document.getElementById("editTel2").value = dataset.numsecundario;
                document.getElementById("editPadecim").value = dataset.padecimientos;

                document.getElementById("modal-EditAlumno").style.display = "block";
            }

            const deleteButton = event.target.closest('.btneliminar');
            if (deleteButton) {
                event.preventDefault();
                const id = deleteButton.dataset.id;
                const nombre = deleteButton.dataset.nombre;

                document.getElementById("deleteID").value = id;
                document.querySelector("#modal-DeleteAlumno h2").textContent = `¿Desea eliminar a "${nombre}" de sus talleres?`;

                const tbody = document.getElementById("talleresAlumno");
                tbody.innerHTML = "<tr><td colspan='2'>Cargando...</td></tr>"; // Feedback

                try {
                    const response = await fetch(`/Profe/FuncionTraerTalleres/${id}`);
                    const talleres = await response.json();

                    tbody.innerHTML = "";
                    if (talleres.length > 0) {
                        talleres.forEach(taller => {
                            tbody.innerHTML += `
                                <tr>
                                    <td>${taller.nombre}</td>
                                    <td>
                                        <input type="checkbox" name="TalleresEliminar" value="${taller.id}" />
                                    </td>
                                </tr>
                            `;
                        });
                    } else {
                        tbody.innerHTML = "<tr><td colspan='2'>No está inscrito en talleres.</td></tr>";
                    }
                } catch(err) {
                    tbody.innerHTML = "<tr><td colspan='2'>Error al cargar talleres.</td></tr>";
                }

                document.getElementById("modal-DeleteAlumno").style.display = "block";
            }
        });

        document.body.addEventListener('click', function(event) {
            if (event.target.classList.contains('cerrar')) {
                event.target.closest('.modal').style.display = 'none';
            }
        });
    });
</script>